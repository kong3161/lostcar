
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏¢</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js">
Chart.defaults.font.family = 'Sarabun';

function formatBarValue(value) {
  return Math.round(value); // remove decimals
}

function addDataLabelsToBarChart(chart) {
  chart.options.plugins = chart.options.plugins || {};
  chart.options.plugins.datalabels = {
    color: '#000',
    anchor: 'end',
    align: 'top',
    formatter: formatBarValue
  };
}

function addLabelsToPieChart(data, labels) {
  const total = data.reduce((sum, val) => sum + val, 0);
  return labels.map((label, i) => {
    const value = data[i];
    const percent = ((value / total) * 100).toFixed(1);
    return `${label}: ${value} ‡∏Ñ‡∏±‡∏ô (${percent}%)`;
  });
}

fetchData().then(data => {
  const container = document.getElementById("model-charts");
  const modelsByType = data.models_by_type;
  const timeStats = data.time_ranges;

  for (const [typeName, models] of Object.entries(modelsByType)) {
    const labels = Object.keys(models);
    const values = Object.values(models);
    createModelChart(container, typeName, labels, values);
    const ctx = document.getElementById(`bar-${(typeName.replace(/[^a-zA-Z0-9]/g, '') || "type")}`);
    if (ctx && ctx.chart) {
      addDataLabelsToBarChart(ctx.chart);
    }
  }

  const timeLabels = Object.keys(timeStats);
  const timeCounts = Object.values(timeStats);
  const pieChart = new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: {
      labels: addLabelsToPieChart(timeCounts, timeLabels),
      datasets: [{
        label: "‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤",
        data: timeCounts,
        backgroundColor: ["#0074D9", "#2ECC40", "#FF851B"]
      }]
    },
    options: {
      responsive: true
    }
  });
});
</script>
  <style>
    body { font-family: 'Sarabun', sans-serif; background-color: #f4f6f8; margin: 0; padding: 2rem; }
    .container { max-width: 960px; margin: auto; background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 0 12px rgba(0,0,0,0.1); }
    h1 { text-align: center; margin-bottom: 2rem; }
    .chart-block { margin-bottom: 3rem; }
    canvas { background-color: #fff; border-radius: 8px; }
    .button { display: inline-block; background-color: #2c3e50; color: white; padding: 10px 16px; text-decoration: none; border-radius: 8px; margin: 10px 5px 0 0; font-size: 1rem; cursor: pointer; text-align: center; }
    .button:hover { background-color: #1a242f; }
    .link-group { text-align: center; margin-top: 2rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ñ‡∏´‡∏≤‡∏¢</h1>
    <div class="chart-block" id="model-charts"></div>
    <div class="chart-block">
      <h3>üïí ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏≤‡∏¢</h3>
      <canvas id="pieChart" height="120"></canvas>
    </div>
    <div class="link-group">
      <a href="/" class="button">üìã ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏ñ‡∏´‡∏≤‡∏¢</a>
      <a href="/search" class="button">üîç ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</a>
      <a href="/results" class="button">üìÅ ‡∏î‡∏π‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</a>
    </div>
  </div>
  <script>
    async function fetchData() {
      const res = await fetch("/dashboard-data");
      return await res.json();
    }

    function createModelChart(container, typeName, labels, data) {
      const safeName = typeName.replace(/[^a-zA-Z0-9]/g, '') || `type${Math.random().toString(36).substr(2, 5)}`;
      const chartId = `bar-${safeName}`;
      const block = document.createElement("div");
      block.className = "chart-block";
      block.innerHTML = `
        <h3>üöó ‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢ - ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${typeName}</h3>
        <canvas id="${chartId}" height="100"></canvas>
      `;
      container.appendChild(block);

      const ctx = document.getElementById(chartId);
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢",
            data: data,
            backgroundColor: "rgba(54, 162, 235, 0.6)"
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function renderPieChart(ctx, labels, data) {
      new Chart(ctx, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            label: "‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤",
            data: data,
            backgroundColor: ["#0074D9", "#2ECC40", "#FF851B"]
          }]
        },
        options: {
          responsive: true
        }
      });
    }

    fetchData().then(data => {
      const container = document.getElementById("model-charts");
      const modelsByType = data.models_by_type;
      const timeStats = data.time_ranges;

      for (const [typeName, models] of Object.entries(modelsByType)) {
        const labels = Object.keys(models);
        const values = Object.values(models);
        createModelChart(container, typeName, labels, values);
      }

      const timeLabels = Object.keys(timeStats);
      const timeCounts = Object.values(timeStats);
      renderPieChart(document.getElementById("pieChart"), timeLabels, timeCounts);
    });
  
Chart.defaults.font.family = 'Sarabun';

function formatBarValue(value) {
  return Math.round(value); // remove decimals
}

function addDataLabelsToBarChart(chart) {
  chart.options.plugins = chart.options.plugins || {};
  chart.options.plugins.datalabels = {
    color: '#000',
    anchor: 'end',
    align: 'top',
    formatter: formatBarValue
  };
}

function addLabelsToPieChart(data, labels) {
  const total = data.reduce((sum, val) => sum + val, 0);
  return labels.map((label, i) => {
    const value = data[i];
    const percent = ((value / total) * 100).toFixed(1);
    return `${label}: ${value} ‡∏Ñ‡∏±‡∏ô (${percent}%)`;
  });
}

fetchData().then(data => {
  const container = document.getElementById("model-charts");
  const modelsByType = data.models_by_type;
  const timeStats = data.time_ranges;

  for (const [typeName, models] of Object.entries(modelsByType)) {
    const labels = Object.keys(models);
    const values = Object.values(models);
    createModelChart(container, typeName, labels, values);
    const ctx = document.getElementById(`bar-${(typeName.replace(/[^a-zA-Z0-9]/g, '') || "type")}`);
    if (ctx && ctx.chart) {
      addDataLabelsToBarChart(ctx.chart);
    }
  }

  const timeLabels = Object.keys(timeStats);
  const timeCounts = Object.values(timeStats);
  const pieChart = new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: {
      labels: addLabelsToPieChart(timeCounts, timeLabels),
      datasets: [{
        label: "‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤",
        data: timeCounts,
        backgroundColor: ["#0074D9", "#2ECC40", "#FF851B"]
      }]
    },
    options: {
      responsive: true
    }
  });
});
</script>
</body>
</html>
