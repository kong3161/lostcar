
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>à¹à¸”à¸Šà¸šà¸­à¸£à¹Œà¸”à¸£à¸°à¸šà¸šà¸„à¹‰à¸™à¸«à¸²à¸£à¸–à¸«à¸²à¸¢</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <style>
    body { font-family: 'Sarabun', sans-serif; background-color: #f4f6f8; margin: 0; padding: 2rem; }
    .container { max-width: 960px; margin: auto; background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 0 12px rgba(0,0,0,0.1); }
    h1 { text-align: center; margin-bottom: 2rem; }
    .chart-block { margin-bottom: 3rem; }
    canvas { background-color: #fff; border-radius: 8px; }
    .button { display: inline-block; background-color: #2c3e50; color: white; padding: 10px 16px; text-decoration: none; border-radius: 8px; margin: 10px 5px 0 0; font-size: 1rem; cursor: pointer; text-align: center; }
    .button:hover { background-color: #1a242f; }
    .link-group { text-align: center; margin-top: 2rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š à¹à¸”à¸Šà¸šà¸­à¸£à¹Œà¸”à¸ªà¸–à¸´à¸•à¸´à¸£à¸–à¸«à¸²à¸¢</h1>
    <div class="chart-block" id="model-charts"></div>
    <div class="chart-block">
      <h3>ğŸ•’ à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸šà¹à¸ˆà¹‰à¸‡à¸«à¸²à¸¢</h3>
      <canvas id="pieChart" height="120"></canvas>
    </div>
    <div class="link-group">
      <a href="/" class="button">ğŸ“‹ à¸à¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¹à¸ˆà¹‰à¸‡à¸£à¸–à¸«à¸²à¸¢</a>
      <a href="/search" class="button">ğŸ” à¹„à¸›à¸«à¸™à¹‰à¸²à¸„à¹‰à¸™à¸«à¸²</a>
      <a href="/results" class="button">ğŸ“ à¸”à¸¹à¸œà¸¥à¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²</a>
    </div>
  </div>
  <script>
    async function fetchData() {
      const res = await fetch("/dashboard-data");
      return await res.json();
    }

    function createModelChart(container, typeName, labels, data) {
      const safeName = typeName.replace(/[^a-zA-Z0-9]/g, '') || `t${Math.random().toString(36).substring(2, 6)}`;
      const chartId = `bar-${safeName}`;

      const block = document.createElement("div");
      block.className = "chart-block";

      // Remove previous canvas if exists
      const oldCanvas = document.getElementById(chartId);
      if (oldCanvas) oldCanvas.remove();

      // Create new canvas
      const heading = document.createElement("h3");
      heading.textContent = `ğŸš— à¸£à¸¸à¹ˆà¸™à¸—à¸µà¹ˆà¸«à¸²à¸¢ - à¸›à¸£à¸°à¹€à¸ à¸—: ${typeName}`;

      const canvas = document.createElement("canvas");
      canvas.id = chartId;
      canvas.height = 100;

      block.appendChild(heading);
      block.appendChild(canvas);
      container.appendChild(block);

      const ctx = document.getElementById(chartId);
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            backgroundColor: labels.map((_, i) => {
              const colors = ['#f87171', '#fb923c', '#facc15', '#4ade80',
                              '#60a5fa', '#a78bfa', '#f472b6', '#34d399'];
              return colors[i % colors.length];
            }),
            label: "à¸ˆà¸³à¸™à¸§à¸™à¸£à¸–à¸—à¸µà¹ˆà¸«à¸²à¸¢",
            data: data,
            backgroundColor: "rgba(54, 162, 235, 0.6)"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: {
              anchor: 'end',
              align: 'end',
              offset: 6,
              color: '#333',
              font: { weight: 'bold', size: 12 },
              formatter: value => Math.round(value)
            },
            datalabels: {
              anchor: 'end',
              align: 'end',
              offset: 6,
              color: '#333',
              font: { weight: 'bold', size: 12 },
              formatter: value => Math.round(value)
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                precision: 0,
                callback: value => Number(value).toFixed(0)
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    function renderPieChart(ctx, labels, data) {
      new Chart(ctx, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            backgroundColor: labels.map((_, i) => {
              const colors = ['#f87171', '#fb923c', '#facc15', '#4ade80',
                              '#60a5fa', '#a78bfa', '#f472b6', '#34d399'];
              return colors[i % colors.length];
            }),
            label: "à¹à¸ˆà¹‰à¸‡à¸«à¸²à¸¢à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²",
            data: data,
            backgroundColor: ["#0074D9", "#2ECC40", "#FF851B"]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: {
              anchor: 'end',
              align: 'end',
              offset: 6,
              color: '#333',
              font: { weight: 'bold', size: 12 },
              formatter: value => Math.round(value)
            },
            datalabels: {
              color: '#000',
              font: { weight: 'bold', size: 12 },
              formatter: (value, ctx) => {
                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                const percent = ((value / total) * 100).toFixed(1);
                return `${value} à¸„à¸±à¸™\n(${percent}%)`;
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    fetchData().then(data => {
      const container = document.getElementById("model-charts");
      const modelsByType = data.models_by_type;
      const timeStats = data.time_ranges;

      for (const [typeName, models] of Object.entries(modelsByType)) {
        const labels = Object.keys(models);
        const values = Object.values(models);
        createModelChart(container, typeName, labels, values);
      }

      const timeLabels = Object.keys(timeStats);
      const timeCounts = Object.values(timeStats);
      renderPieChart(document.getElementById("pieChart"), timeLabels, timeCounts);
    });
  </script>
</body>
</html>
